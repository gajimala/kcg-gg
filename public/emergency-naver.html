<!DOCTYPE html> 
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>인명구조함 지도 (네이버 앱용)</title>

  <!-- ✅ 네이버 지도 API: ncpKeyId 사용 -->
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=y6akfogygp"></script>

  <!-- ✅ 지도 스타일 -->
  <style>
    html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
    #map { position: relative; }

    #locationButton, #mapTypeSelector, #sosButton {
      position: absolute;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      z-index: 100;
    }

    #locationButton { top: 10px; left: 10px; }
    #mapTypeSelector { top: 50px; left: 10px; }

    #sosButton {
      top: 10px; right: 10px;
      background: #ffdddd;
      color: red;
      font-weight: bold;
      border-radius: 8px;
      padding: 8px 12px;
      max-width: 150px;
    }

    #locationButton:hover, #mapTypeSelector:hover, #sosButton:hover {
      background: rgba(240, 240, 240, 0.9);
    }
  </style>
</head>
<body>
  <!-- ✅ 지도 렌더링 영역 및 버튼 -->
  <div id="map"></div>
  <button id="locationButton">내 위치로 이동</button>
  <button id="mapTypeSelector">위성 지도</button>
  <button id="sosButton">🚨 구조 요청</button>

  <!-- ✅ Firebase 및 앱 로직 -->
  <script type="module">
    // ✅ Firebase SDK 로드
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

    // ✅ Firebase 초기 설정
    const firebaseConfig = {
      apiKey: "AIzaSyDAWuBw94gzYiPrUTOY41zque2WvgCnRj4",
      authDomain: "kcghelp-cf3e4.firebaseapp.com",
      databaseURL: "https://kcghelp-cf3e4-default-rtdb.firebaseio.com",
      projectId: "kcghelp-cf3e4",
      storageBucket: "kcghelp-cf3e4.appspot.com",
      messagingSenderId: "374111271871",
      appId: "1:374111271871:web:d1cf45fdc2a93930c77f0a",
      measurementId: "G-DGDBZ38LW4"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ✅ 구조 요청 저장 함수
    function sendSosRequest(lat, lng) {
      const requestsRef = ref(database, 'emergency/requests');
      return push(requestsRef, {
        lat: lat,
        lng: lng,
        timestamp: Date.now()
      });
    }

    // ✅ 네이버 지도 초기화
    var map = new naver.maps.Map(document.getElementById('map'), {
      center: new naver.maps.LatLng(37.5665, 126.9780),
      zoom: 17,
      mapTypeId: naver.maps.MapTypeId.NORMAL
    });

    var markers = [];
    var lifesavers = [];
    var myLocationMarker = null;
    var myLat = null;
    var myLng = null;
    var watchId = null;
    var infoWindow = new naver.maps.InfoWindow();

    // ✅ 첫 페이지 로드 시 위치 권한 요청
    window.onload = function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          console.log("위치 제공 수락됨", position.coords.latitude, position.coords.longitude);
        }, function(error) {
          console.error("위치 제공 거부됨:", error);
          alert("위치 정보 제공을 허용해야 합니다.");
        });
      } else {
        alert("위치 정보 제공을 지원하지 않는 브라우저입니다.");
      }
    };

    // ✅ 위치 추적 시작
    function startTracking() {
      let hasCenteredOnce = false;

      if (navigator.geolocation) {
        watchId = navigator.geolocation.watchPosition(function(position) {
          myLat = position.coords.latitude;
          myLng = position.coords.longitude;
          var myLocation = new naver.maps.LatLng(myLat, myLng);

          if (myLocationMarker) {
            myLocationMarker.setPosition(myLocation);
          } else {
            myLocationMarker = new naver.maps.Marker({
              position: myLocation,
              map: map,
              icon: {
                content: '<div style="width:12px;height:12px;background:#4285F4;border-radius:50%;border:2px solid white;"></div>',
                anchor: new naver.maps.Point(6, 6)
              }
            });
          }

          if (!hasCenteredOnce) {
            map.setCenter(myLocation);
            hasCenteredOnce = true;
          }
        }, function(error) {
          console.error("위치 추적 실패:", error);
        }, {
          enableHighAccuracy: true,
          maximumAge: 0
        });
      }
    }

    // ✅ lifesavers.json 로드
    function loadMarkers() {
      fetch("/lifesavers")
        .then(response => response.json())
        .then(data => {
          lifesavers = data;
          data.forEach(item => {
            var lat = parseFloat(item.lat);
            var lng = parseFloat(item.lng);

            if (!isNaN(lat) && !isNaN(lng)) {
              var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(lat, lng),
                map: map,
                title: item.name || "인명구조함",
                icon: {
                  url: "/help.png",
                  size: new naver.maps.Size(27, 30),
                  scaledSize: new naver.maps.Size(27, 30),
                  origin: new naver.maps.Point(0, 0),
                  anchor: new naver.maps.Point(13, 30)
                }
              });
              markers.push(marker);

              // ✅ 마커 클릭 시 네이버 앱 길찾기
              naver.maps.Event.addListener(marker, 'click', function() {
                if (myLat === null || myLng === null) {
                  alert('현재 위치를 가져올 수 없습니다.');
                  return;
                }

                const appname = 'com.example.app';
                const nmapUrl = `nmap://route/car?slat=${myLat}&slng=${myLng}&dlat=${lat}&dlng=${lng}&appname=${appname}`;

                const iwContent = `
                  <div style="padding:6px; font-size:13px;">
                    ${item.name || "인명구조함"}<br>
                    <button onclick="window.location.href='${nmapUrl}'" style="margin-top:5px; background:none; border:none; color:blue; text-decoration:underline; cursor:pointer;">
                      길찾기 (네이버앱)
                    </button>
                  </div>
                `;
                infoWindow.setContent(iwContent);
                infoWindow.open(map, marker);
              });
            }
          });
          updateMarkers();
        })
        .catch(err => console.error("lifesavers.json 불러오기 오류:", err));
    }

    // ✅ 현재 지도 화면 기준으로 마커 표시 여부 결정
    function updateMarkers() {
      if (lifesavers.length === 0) return;

      const bounds = map.getBounds();
      const sw = bounds.getSW();
      const ne = bounds.getNE();

      markers.forEach((marker, index) => {
        const item = lifesavers[index];
        if (item.lat >= sw._lat && item.lat <= ne._lat &&
            item.lng >= sw._lng && item.lng <= ne._lng) {
          marker.setMap(map);
        } else {
          marker.setMap(null);
        }
      });
    }

    // ✅ 지도 이동 시 마커 업데이트
    naver.maps.Event.addListener(map, 'bounds_changed', updateMarkers);

    // ✅ 위치 추적 및 마커 로드 실행
    startTracking();
    loadMarkers();

    // ✅ "내 위치로 이동" 버튼
    document.getElementById('locationButton').addEventListener('click', () => {
      if (myLat && myLng) {
        map.setCenter(new naver.maps.LatLng(myLat, myLng));
        map.setZoom(17);
      }
    });

    // ✅ "지도 유형 토글" 버튼
    document.getElementById('mapTypeSelector').addEventListener('click', function() {
      if (map.getMapTypeId() === naver.maps.MapTypeId.NORMAL) {
        map.setMapTypeId(naver.maps.MapTypeId.SATELLITE);
        this.textContent = "일반 지도";
      } else {
        map.setMapTypeId(naver.maps.MapTypeId.NORMAL);
        this.textContent = "위성 지도";
      }
    });

    // ✅ 구조 요청 버튼 동작 (Firebase에 저장)
    document.getElementById('sosButton').addEventListener('click', function() {
      if (myLat && myLng) {
        const agree = confirm("[위치정보 제공 동의]\n구조 요청 시 현재 위치가 전송되며, 요청 정보는 24시간 뒤 자동 삭제됩니다.\n계속하시겠습니까?");
        if (!agree) return;

        // ✅ Firebase에 구조 요청 저장
        sendSosRequest(myLat, myLng)
          .then(() => {
            alert("구조 요청이 접수되었습니다.");
          })
          .catch((err) => {
            alert("요청 저장 실패: " + err);
          });

      } else {
        alert("현재 위치를 가져올 수 없습니다.");
      }
    });
  </script>
</body>
</html>
